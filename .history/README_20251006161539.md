# MOQ Pools – Complete MVP (Supplier Drop‑Ship)
# MOQ Pools – Complete MVP (Supplier Drop‑Ship)

## Quick Start
```bash
pnpm install
cp .env.example .env
# set DATABASE_URL and APP_BASE_URL
pnpm prisma:generate
pnpm prisma:migrate
pnpm prisma:seed
pnpm dev
```

## Routes
 `/products` – list pools
 `/p/:id` – product page → join & pay (Stripe)
 `/pay/success` – success
 `/admin/pools` – export CSV & place order
 `/admin/payments` – list payments
 `/admin/shipments` – upload tracking CSV

## Stripe (dev)
```bash
stripe listen --events checkout.session.completed --forward-to http://localhost:3000/api/webhooks/stripe
```

Then put the printed `whsec_...` in `.env` as `STRIPE_WEBHOOK_SECRET`.

## External listings (Alibaba / 1688 / Made-in-China / IndiaMART)


- `GET /api/external/aggregate?platform=ALL|ALIBABA|C1688|MADE_IN_CHINA|INDIAMART&q=term&offset=0&limit=100&minPrice=&maxPrice=&minMoq=&maxMoq=`

Notes:
- Currency detection (₹ / Rs / INR) normalizes to `currency: "INR"` while preserving original `price` string.
- MOQ parsing extracts common patterns: `MOQ 100`, `Minimum Order Quantity 5`, `≥ 50`.
- `scripts/ingestIndiaMartMnuTree.ts` Traverse and ingest the full IndiaMART export category subtree rooted by a URL token (default `mnu`).

### IndiaMART "mnu" subtree ingestion & browsing

The `mnu` token corresponds to a family of export.indiamart.com category URLs. To ingest and then view listings for all categories and subcategories containing this token:

Ingest (dry run first):

```
pnpm ts-node scripts/ingestIndiaMartMnuTree.ts --debug --dry
```

Run for real with detail enrichment (optional):

```
pnpm ts-node scripts/ingestIndiaMartMnuTree.ts --detail --per-detail 5 --page-limit 120 --sparse-threshold 6 --min-informative 2
```

Browse in the app (development server required):

Open: `/indiamart?category=mnu` (defaults to `mnu` if omitted). Pagination query params: `page`, `pageSize` (max 100). `recursive=1` aggregates descendant categories.

UI page form fields:
- `category` slug (derived from export category label slugification used during ingestion)
- `pageSize` (1–100, defaults 40)

Pagination links are rendered at the bottom (capped at 50 pages for safety). Example direct navigation:

```
/indiamart?category=mnu&page=3&pageSize=60
```

API endpoint example:

```
/api/indiamart/listings?category=mnu&recursive=1&page=1&pageSize=40
```

Saved listings are stored in `SavedListing` with `platform='INDIAMART'` and category slugs derived via the same slug logic used in ingestion scripts.

- Optional `cacheImages` flag to store images locally via `imageCache` (use for ingestion / catalog priming jobs).
 - INR currency parsing added (₹ / INR / Rs.) so pricing filters can work with IndiaMART listings.

Example (script usage):
```bash
cross-env TS_NODE_PROJECT=tsconfig.scripts.json node -r ts-node/register -r tsconfig-paths/register scripts/printIndiaMart.ts "usb fan"
```

## Category Metadata & Ingestion Rotation

To broaden coverage evenly across verticals (including new IndiaMART‑aligned ones) a lightweight rotation system generates search jobs from the category model.

### Category Fields (extended)
Each entry in `src/lib/categories.ts` now supports:

- `term`: Primary canonical search term (always included)
- `aliases`: Alternative phrasings / pluralizations (optional; lower weight)
- `featured`: Curated high‑intent subterms (optionally sampled)
- `tags`: Semantic grouping labels (e.g. `industrial`, `medical`, `packaging`)
- `weight`: Relative emphasis (default 1; >1 increases frequency)
- `ingest.priority`: Higher number floats earlier in global ordering
- `ingest.maxFeaturedPerCycle`: Cap featured queries per category per rotation

### Rotation Logic
Implemented in `src/lib/categoryRotation.ts`:
1. Categories sorted by (priority desc, weight desc)
2. For each category we build a bucket: base term + a shuffled slice of featured + (optionally) aliases
3. Bucket trimmed to `perCategory` (default 6) while ensuring the base term is retained
4. Global list lightly re‑shuffled with a score influenced by RNG, priority, and weight
5. Determinism: pass a `seed` to reproduce job sequences

### Generating Job Config JSON
Script: `scripts/buildCategoryRotationConfig.ts`

Usage examples:
```bash
# Default (all platforms logical placeholder 'ALL')
node dist/scripts/buildCategoryRotationConfig.js > rotation.json

# With ts-node during development
cross-env TS_NODE_PROJECT=tsconfig.scripts.json node -r ts-node/register -r tsconfig-paths/register scripts/buildCategoryRotationConfig.ts --seed=42 --per-category=5 --max-total=80 > rotation.json

# Disable aliases
... buildCategoryRotationConfig.ts --no-aliases --max-total=120 > rotation.json

# Only 40 total jobs, include all alias + featured terms
... buildCategoryRotationConfig.ts --seed=123 --per-category=4 --max-total=40 > rotation.json
```

Generated JSON shape:
```jsonc
{
	"generatedAt": "2025-09-24T10:11:12.345Z",
	"platform": "ALL",
	"categories": 74,
	"jobs": [
		{ "platform": "ALL", "q": "hospital beds", "limit": 180 },
		{ "platform": "ALL", "q": "syringe", "limit": 180 },
		{ "platform": "ALL", "q": "nebulizer machine", "limit": 180 }
	]
}
```

### Feeding Jobs Into Ingestion
You can iterate the `jobs` array and call the existing external search endpoint, or a headless provider function directly (for batch seeding / caching images):
```ts
// pseudo-code
import fs from 'node:fs';
import fetch from 'node-fetch';
const cfg = JSON.parse(fs.readFileSync('rotation.json','utf8'));
for (const job of cfg.jobs) {
	const url = new URL('http://localhost:3000/api/external/search');
	// Upsert listings or trigger downstream processing...
}
```

### Tuning Strategy
- Increase `weight` for under‑represented but valuable verticals
- Use `aliases` sparingly; they dilute focus—prefer `featured` for high‑intent terms
- Set `ingest.priority` high (e.g. 5) for launch‑critical categories (medical / packaging) so they appear earlier each cycle
- Adjust `--per-category` vs `--max-total` to balance breadth vs depth

	### IndiaMART Export Directory Fallback

	Some niche medical / textile subcategories surface more reliably on the export‑focused domain `export.indiamart.com`. When the primary IndiaMART scraper returns fewer than 4 listings for a term, an automatic lightweight fallback now queries the export search page. If it finds a richer set, those listings are used instead. This improves coverage for terms like “Disposable Fabrics” or narrow drape / gown variants.

	Enabled by default. To disable set:
	```
	ENABLE_IM_EXPORT_FALLBACK=0
	```
	in your `.env` and restart.

	### Discover Additional Export Categories

	Script: `scripts/buildIndiaMartExportCategories.ts`

	Example:
	```bash
	pnpm ts-node scripts/buildIndiaMartExportCategories.ts --seeds "Hospital Linen,Medical Scrub" --limit 3 --out exportCats.json --debug 1
	```

	Outputs JSON like:
	```jsonc
	{
		"generatedAt": "2025-10-06T12:34:56.000Z",
		"seeds": ["Hospital Linen","Medical Scrub"],
		"results": {
			"Hospital Linen": [ { "label": "Hospital Bed Sheet", "count": 3227, "url": "https://export.indiamart.com/search.php?..." } ]
		}
	}
	```

	Flags:
	- `--seeds` Comma or pipe separated list of starting terms
	- `--limit` Top N subcategories (by parsed count) to enqueue per term
	- `--out` Output filename (default `indiamart.export.categories.json`)
	- `--debug 1` Verbose logging

	Use discovered labels as new ingestion seeds or to enrich the hierarchical taxonomy.

	### Export Ingestion Script

	Script: `scripts/ingestIndiaMartExport.ts`

	Purpose: crawl export categories (with limited breadth/depth) and persist listings into SavedListings when the primary directory is sparse.

	Example:
	```bash
	pnpm ts-node scripts/ingestIndiaMartExport.ts --seeds "Hospital Linen,Medical Scrub" --depth 2 --per 3 --limit 150 --detail 0 --debug 1
	```
	Flags:
	- `--seeds` Seed terms
	- `--depth` BFS depth (default 1)
	- `--per` How many top subcategories (by count) to expand per term (breadth)
	- `--limit` Max listings per term for primary IndiaMART fetch before considering export anchors
	- `--detail 1` Fetch export product detail pages for better titles/prices (slower)
	- `--debug 1` Verbose logging

	### Adaptive Warm Fetch Suppression

	The IndiaMART background “warm” full fetch is skipped when the initial prefetch returns ≥ 40 items, reducing unnecessary duplicate provider calls on rich categories. Threshold can be tuned in `IndiaMartWarmFetchClient` (`initialCount >= 40`).
### Future Enhancements (Optional)
- Persist rotation state to skip already‑queried jobs mid‑cycle
- Telemetry: adapt weights based on conversion / click metrics
- Tag‑scoped generation: add CLI `--tag=medical,industrial` filter
- Multi‑platform splitting: emit separate jobs per platform (ALIBABA, INDIAMART, etc.) instead of placeholder `ALL`

---

If you add new categories, just supply at minimum: `{ key, term }`. The rotation will immediately include them using defaults.


## IndiaMART Hierarchical Taxonomy & Fallback Search

IndiaMART uses a dedicated hierarchical taxonomy (separate from the flat `categories.ts`) defined in `src/lib/indiamartCategories.ts`:

Structure:
```
Top Level Group
	└─ Subgroup (node)
			 └─ Leaves (searchable leaves with primary term + optional aliases)
```

Example (excerpt):
```
Hospital and Medical Equipment
	└─ Medical Laboratory Instruments
			 ├─ Rapid Test Kit
			 ├─ Biochemistry Analyzer
			 └─ Hematology Analyzers
```

### UI
`<IndiaMartCategoryMenu />` renders only when the active platform is `INDIAMART` (via `PlatformProvider` / `usePlatform`). Selecting a leaf emits ordered fallback terms.

### Fallback Strategy
When a leaf is chosen we build an ordered list of escalating search terms:
1. Leaf primary `term`
2. Any `aliases`
3. Parent subgroup label
4. Top-level group label

The API route `GET /api/external/search` now supports:
- `lk=<leafKey>` (IndiaMART only) to auto-expand fallback list.
- Manual multi-term fallback using `q=termA||termB||termC`.

Escalation stops early once a minimum result threshold is reached or all terms are exhausted. Duplicates are deduped by URL.

### Helpers
`getIndiaMartSearchTerms(leafKey)` returns the ordered unique list used for fallback.
`findIndiaMartLeaf(leafKey)` finds the leaf metadata (label, term, aliases).

### Extending the Taxonomy
1. Add / edit groups, subgroups, or leaves in `indiamartCategories.ts` (ensure unique `key`).
2. Provide a `term` (normalized search phrase). Add `aliases` only when they materially surface different supplier sets.
3. No rebuild needed—Next.js hot reload picks up changes; UI + API fallback will immediately include them.

### Why Separate From Generic Categories?
- IndiaMART vertical breadth & naming differs from Alibaba / 1688; a shared flat list caused noisy / low-yield queries.
- Hierarchical UX improves discoverability and supports context-aware fallback when niche leaves have sparse supply.

### Future Ideas
- Persist per-leaf success metrics to adapt alias ordering.
- Add weight/prioritization to subgroups similar to main rotation logic.
- Offer combined cross-platform mapping (e.g., map an IndiaMART leaf to analogous Alibaba terms) for comparative sourcing.

---

### Troubleshooting (IndiaMART)
| Symptom | Likely Cause | Action |
|---------|--------------|--------|
| Few/no results for a specific leaf | Niche term or requires headless | Retry with headless=1 or rely on fallback escalation |
| Duplicates across fallback terms | Same listing matches multiple broader terms | URL-based dedupe already applied; safe to ignore |
| Very slow queries | Headless Playwright render engaged | Disable headless (`&headless=0`) to compare baseline |

### Bulk IndiaMART Ingestion
For deeper coverage (so category pages show many listings immediately) use the bulk script which walks every taxonomy leaf and ingests the first N terms.

Script: `scripts/ingestIndiaMartBulk.ts`

Added npm script:
```bash
pnpm run indiamart:bulk             # default limit=300, terms per leaf=2, headless off
pnpm run indiamart:bulk -- --limit 500 --terms 3 --headless 1 --debug 1
```

Flags:
- `--limit <n>`   max items per term (capped internally)
- `--terms <n>`   number of terms per leaf (default 2)
- `--headless 1`  enable Playwright headless fallback
- `--resumeJson path` keep progress & skip already ingested pairs
- `--debug 1`     verbose scraping logs

Progress file example (resume):
```json
{
	"hospital_laboratory::rapid test kit": 112,
	"hospital_laboratory::biochemistry analyzer": 98
}
```

Run it periodically to grow the local SavedListing cache; front-end will pick up more listings instantly via snapshot/saved queries before live scraping.


