# MOQ Pools – Complete MVP (Supplier Drop‑Ship)
# MOQ Pools – Complete MVP (Supplier Drop‑Ship)

## Quick Start
```bash
pnpm install
cp .env.example .env
# set DATABASE_URL and APP_BASE_URL
pnpm prisma:generate
pnpm prisma:migrate
pnpm prisma:seed
pnpm dev
```

## Routes
 `/products` – list pools
 `/p/:id` – product page → join & pay (Stripe)
 `/pay/success` – success
 `/admin/pools` – export CSV & place order
 `/admin/payments` – list payments
 `/admin/shipments` – upload tracking CSV

## Stripe (dev)
```bash
stripe listen --events checkout.session.completed --forward-to http://localhost:3000/api/webhooks/stripe
```

Then put the printed `whsec_...` in `.env` as `STRIPE_WEBHOOK_SECRET`.

## External listings (Alibaba / 1688 / Made-in-China / IndiaMART)

- Page-based browsing lives at `/products` with 50/100/200 per page.
- Cross-platform aggregation with de-duplication and filters (price/MOQ).
- Server-side caching (in-memory TTL) speeds repeated queries and stabilizes pagination.

Endpoints:
- `GET /api/external/search?platform=ALIBABA|C1688|MADE_IN_CHINA|INDIAMART&q=term&limit=60`
- `GET /api/external/aggregate?platform=ALL|ALIBABA|C1688|MADE_IN_CHINA|INDIAMART&q=term&offset=0&limit=100&minPrice=&maxPrice=&minMoq=&maxMoq=`

Notes:
- Scrapers use static HTML parsing; some queries may return fewer items than the official sites which render dynamically. Consider a headless fetcher (e.g., Playwright) in production if needed.
- The in-memory cache is per-process and resets on redeploy. For horizontal scale, use Redis.

### IndiaMART Provider Enhancements

- Currency detection (₹ / Rs / INR) normalizes to `currency: "INR"` while preserving original `price` string.
- MOQ parsing extracts common patterns: `MOQ 100`, `Minimum Order Quantity 5`, `≥ 50`.
- Optional headless fallback (Playwright) when `headless=1` or `opts.headless` and static HTML returns sparse results.
- Optional `upgradeImages` flag (not enabled by default in API routes) to fetch detail pages for a better primary image.
- Optional `cacheImages` flag to store images locally via `imageCache` (use for ingestion / catalog priming jobs).

Example (script usage):
```bash
cross-env TS_NODE_PROJECT=tsconfig.scripts.json node -r ts-node/register -r tsconfig-paths/register scripts/printIndiaMart.ts "usb fan"
```

